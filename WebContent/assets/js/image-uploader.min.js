/*! Image Uploader - v1.2.3 - 26/11/2019
 * Copyright (c) 2019 Christian Bayer; Licensed MIT */
!function($){$.fn.imageUploader=function(options){let defaults={preloaded:[],imagesInputName:"images",preloadedInputName:"preloaded",label:"Drag & Drop files here or click to browse",extensions:[".jpg",".jpeg",".png",".gif",".svg"],mimes:["image/jpeg","image/png","image/gif","image/svg+xml"],maxSize:void 0,maxFiles:void 0},plugin=this,dataTransfer=new DataTransfer,$input;plugin.settings={},plugin.init=function(){plugin.settings=$.extend(plugin.settings,defaults,options),plugin.each((function(i,wrapper){let $container=createContainer();if($(wrapper).append($container),$container.on("dragover",fileDragHover.bind($container)),$container.on("dragleave",fileDragHover.bind($container)),$container.on("drop",fileSelectHandler.bind($container)),plugin.settings.preloaded.length){$container.addClass("has-files");let $uploadedContainer=$container.find(".uploaded");for(let i=0;i<plugin.settings.preloaded.length;i++)$uploadedContainer.append(createImg(plugin.settings.preloaded[i].src,plugin.settings.preloaded[i].id,!0))}}))};let createContainer=function(){let $container=$("<div>",{class:"image-uploader"});$input=$("<input>",{type:"file",id:plugin.settings.imagesInputName+"-"+random(),name:plugin.settings.imagesInputName+"[]",accept:plugin.settings.extensions.join(","),multiple:"",required:"required"}).appendTo($container);let $uploadedContainer=$("<div>",{class:"uploaded"}).appendTo($container),$textContainer=$("<div>",{class:"upload-text"}).appendTo($container),$i=$("<i>",{class:"fas fa-upload"}).appendTo($textContainer),$span=$("<span>",{text:plugin.settings.label}).appendTo($textContainer);return $container.on("click",(function(e){prevent(e),$input.trigger("click")})),$input.on("click",(function(e){e.stopPropagation()})),$input.on("change",fileSelectHandler.bind($container)),$container},prevent=function(e){e.preventDefault(),e.stopPropagation()},createImg=function(src,id,preloaded){let $container=$("<div>",{class:"uploaded-image"}),$img=$("<img>",{src:src}).appendTo($container),$button=$("<button>",{class:"delete-image"}).appendTo($container),$i=$("<i>",{class:"fas fa-times"}).appendTo($button);if(preloaded){$container.attr("data-preloaded",!0);let $preloaded=$("<input>",{type:"hidden",name:plugin.settings.preloadedInputName+"[]",value:id}).appendTo($container)}else $container.attr("data-index",id);return $container.on("click",(function(e){prevent(e)})),$button.on("click",(function(e){prevent(e);let $parent=$container.parent();if(!0===$container.data("preloaded"))plugin.settings.preloaded=plugin.settings.preloaded.filter((function(p){return p.id!==id}));else{let index=parseInt($container.data("index"));$parent.find(".uploaded-image[data-index]").each((function(i,cont){i>index&&$(cont).attr("data-index",i-1)})),dataTransfer.items.remove(index),$input.prop("files",dataTransfer.files)}$container.remove(),$parent.children().length||$parent.parent().removeClass("has-files")})),$container},fileDragHover=function(e){prevent(e),"dragover"===e.type?$(this).addClass("drag-over"):$(this).removeClass("drag-over")},fileSelectHandler=function(e){prevent(e);let $container=$(this),files=Array.from(e.target.files||e.originalEvent.dataTransfer.files),validFiles=[];$(files).each((function(i,file){plugin.settings.extensions&&!validateExtension(file)||plugin.settings.mimes&&!validateMIME(file)||plugin.settings.maxSize&&!validateMaxSize(file)||plugin.settings.maxFiles&&!validateMaxFiles(validFiles.length,file)||validFiles.push(file)})),validFiles.length?($container.removeClass("drag-over"),setPreview($container,validFiles)):$input.prop("files",dataTransfer.files)};toastr.options={positionClass:"toast-top-center",showDuration:"300",hideDuration:"500",timeOut:"2000"};let validateExtension=function(file){return!(plugin.settings.extensions.indexOf(file.name.replace(new RegExp("^.*\\."),"."))<0)||(msg=`El archivo "${file.name}" no coincide con las extensiones de archivo aceptadas: "${plugin.settings.extensions.join('", "')}"`,$(document).Toasts("create",{class:"bg-warning",title:"Tamaño max superado",body:msg}),!1)},validateMIME=function(file){return!(plugin.settings.mimes.indexOf(file.type)<0)||(msg=`El archivo "${file.name}" no coincide con los tipos de formato de imagen aceptados: "${plugin.settings.mimes.join('", "')}"`,$(document).Toasts("create",{class:"bg-warning",title:"Tamaño max superado",body:msg}),!1)},validateMaxSize=function(file){return!(file.size>plugin.settings.maxSize)||(msg=`La imagen "${file.name}" excede el tamaño máximo de: ${plugin.settings.maxSize/1024/1024}Mb`,$(document).Toasts("create",{class:"bg-warning",title:"Tamaño max superado",body:msg}),!1)},validateMaxFiles=function(index,file){return!(index+dataTransfer.items.length+plugin.settings.preloaded.length>=plugin.settings.maxFiles)||(msg=`La imagen "${file.name}" no pudo ser añadido porque se alcanzó el límite de archivos: ${plugin.settings.maxFiles}`,$(document).Toasts("create",{class:"bg-warning",title:"Max. imagenes superado",body:msg}),!1)},setPreview=function($container,files){$container.addClass("has-files");let $uploadedContainer=$container.find(".uploaded"),$input=$container.find('input[type="file"]');$(files).each((function(i,file){dataTransfer.items.add(file),$uploadedContainer.append(createImg(URL.createObjectURL(file),dataTransfer.items.length-1),!1)})),$input.prop("files",dataTransfer.files)},random=function(){return Date.now()+Math.floor(100*Math.random()+1)};return this.init(),this}}(jQuery);